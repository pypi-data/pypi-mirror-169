# 零、前言

## 前言

当你拿起这本书时，你可能会想，为什么又是一本关于密码学的书？甚至，我为什么要读这本书？要回答这个问题，你必须了解这一切是从什么时候开始的。

### 酝酿多年的一本书

今天，如果你想了解几乎任何东西，你可以用谷歌、必应或百度——你会明白的。然而，对于密码术来说，取决于你在寻找什么，资源可能是相当缺乏的。这是我很久以前遇到的事情，从那以后一直是我沮丧的来源。

当我还在学校的时候，我不得不为一个班级实施差分功耗分析攻击。这一攻击是当时密码分析的一个突破，因为它是第一个公开发表的旁道攻击。差分功耗分析攻击是一件神奇的事情:通过测量设备加密或解密时的功耗，您可以提取其机密。我意识到，伟大的论文可以传达伟大的思想，而在清晰度和可理解性方面几乎不花力气。我记得我用头撞墙，试图弄清楚作者想说什么。更糟糕的是，我找不到解释这篇论文的好的在线资源。所以我又敲了敲我的头，最后我明白了。然后，我想，也许我可以帮助像我一样将要经历这种磨难的人。

受到激励，我画了一些图表，将它们做成动画，并记录下自己浏览它们的过程。那是我第一个关于密码学的 YouTube 视频:https://www.youtube.com/watch?v=gbqNCgVcXsM。

多年后，在我上传视频后，我仍然在网上收到来自随机人群的称赞。就在昨天，就在我写这篇序言的时候，有人发帖说，“谢谢你，真的是一个很棒的解释，可能节省了我试图理解这篇论文的几个小时。”

多好的奖励啊！我在教育领域的另一边冒险迈出的这一小步足以让我想做更多。我开始录制更多这样的视频，然后我开始写关于密码学的博客。你可以在这里查看:【https://cryptologie.net】。

在开始写这本书之前，我已经收集了近 500 篇文章，解释了本简介之外的许多概念。这只是练习。在我内心深处，写一本书的想法在曼宁出版公司主动向我提出出书建议的几年前就已经慢慢成熟了。

### 真实世界的密码学家课程

我完成了理论数学的学士学位，不知道下一步会是什么。我一生都在编程，我想调和这两者。很自然地，我对密码学产生了好奇，它似乎拥有两个世界的优点，并且开始阅读我手头的不同书籍。我很快发现了我的人生使命。

然而，有些事情很烦人:尤其是以历史开始的冗长介绍；我只对技术细节感兴趣，一直都是。我对自己发誓，如果我要写一本关于密码学的书，我不会写一行关于维格纳密码、凯撒密码和其他历史遗迹的内容。因此，在波尔多大学获得密码学硕士学位后，我想我已经准备好面对现实世界了。我一点也不知道。

我相信我的学位已经足够了，但是我所受的教育缺乏很多关于我将要攻击的现实世界协议的知识。我花了很多时间学习椭圆曲线的数学知识，但完全不知道它们是如何用于加密算法的。我了解了 LFSRs、ElGamal 和 DES，以及一系列我再也看不到的其他密码原语。

当我开始在 Matasano(后来成为 NCC 集团)的行业中工作时，我的第一份工作是审计 OpenSSL，这是最受欢迎的 SSL/TLS 实现——基本上加密了整个互联网的代码。哦，天啊，它伤了我的大脑。我记得每天带着强烈的头痛回到家。多么糟糕的图书馆和协议啊！我当时并不知道，多年后，我会成为 TLS 1.3(该协议的最新版本)的合著者。

但是，在那时，我已经在想，“这是我应该在学校里学到的。我现在获得的知识对我进入现实世界很有用！”毕竟，我现在是密码学领域的专业安全从业者。我在回顾现实世界的加密应用。我做的工作是一个人在完成密码学学位后所希望做的。我实现、验证、使用并建议使用什么加密算法。这就是为什么我是我写的这本书的第一个读者。为了让过去的自己为现实世界做好准备，我会这样写给他。

### 大多数虫子在哪里

我的咨询工作让我审计了许多真实世界的加密应用程序，例如 OpenSSL、Google 的加密备份系统、Cloudflare 的 TLS 1.3 实现、Let's Encrypt 的证书授权协议、Zcash 加密货币的 sapling 协议、NuCypher 的门限代理再加密方案，以及其他几十个我不幸不能公开提及的真实世界的加密应用程序。

在我工作的早期，我的任务是审核一家知名公司为加密他们的通信而编写的定制协议。事实证明，它几乎在所有东西上都使用了签名，除了短暂的密钥，这完全破坏了整个协议，因为人们可以很容易地替换那些——任何对安全传输协议有一些经验的人都犯了一个新手错误，但一些认为自己有足够经验来滚动自己的密码的人却忽略了这一点。我记得在约定结束时解释了这个漏洞，一屋子的工程师沉默了足足 30 秒。

在我的职业生涯中，这个故事重复了很多次。曾经有一段时间，在为另一个客户审计加密货币时，我发现了一种从已经存在的交易中伪造交易的方法，因为签署的内容有些模糊。在查看另一个客户的 TLS 实现时，我发现了一些破坏 RSA 实现的微妙方法，这反过来又转化为 RSA 发明者之一的白皮书，导致向十几个开源项目报告了许多常见漏洞和暴露(CVE)。最近，当我在写书的过程中读到更新的 Matrix 聊天协议时，我意识到他们的认证协议被破坏了，导致他们的端到端加密被破坏。不幸的是，在使用加密技术时，有太多的细节可能会在你面前崩溃。在这一点上，我知道我必须写一些关于这些。这就是为什么我的书包含了许多这样的轶事。

作为工作的一部分，我会回顾各种编程语言的加密库和应用程序。我发现了 bug(例如，Golang 的标准库中的 CVE-2016-3959)，我研究了库可以欺骗你滥用这些 bug 的方法(例如，我的论文“如何后门 Diffie-Hellman”)，我还建议使用什么库。开发人员从来不知道使用什么库，我也总是觉得这个问题很棘手。

我接着发明了迪斯科协议(【https://discocrypto.com】T2)；)并用不到 1000 行代码编写了功能齐全的密码库，而且是用几种语言编写的。Disco 只依赖于两个密码原语:SHA-3 和 Curve25519 的置换。是的，仅从这两个用 1，000 行代码实现的东西，开发人员就可以完成任何类型的认证密钥交换、签名、加密、MAC、哈希、密钥派生等等。这给了我一个独特的视角来看待一个好的密码术库应该是什么样的。

我希望我的书包含这些实用的见解。因此，很自然地，不同的章节包含了如何在不同的编程语言中应用“crypto”的例子，使用备受推崇的加密库。

### 需要一本新书？

当我在 Black Hat(一个著名的安全会议)上进行年度密码学培训时，一名学生找到我，问我是否可以推荐一本关于密码学的好书或在线课程。我记得我建议学生阅读 Boneh 和 Shoup 的书，并在 Coursera 上参加 Boneh 的密码学 I。(我也推荐这两个资源在这本书的最后。)

学生跟我说:“啊，我试过了，太理论了！”这个答案一直伴随着我。我一开始不同意，但慢慢意识到他们是对的。大多数资源在数学上相当繁重，并且大多数与加密技术交互的开发人员不想与数学打交道。对他们来说还有什么？

另外两个在当时有点受尊重的资源是和(都是 Bruce Schneier 的书)。但是这些书已经开始过时了。*应用密码学*花了四章讨论分组密码，其中一整章讨论密码操作模式，但没有讨论认证加密。最近的*密码学工程*在一个脚注中只提到了椭圆曲线密码。另一方面，我的许多视频或博客帖子正在成为一些加密概念的很好的主要参考资料。我知道我可以做一些特别的事情。

渐渐地，我的许多学生开始对加密货币感兴趣，并就此提出越来越多的问题。与此同时，我开始审核越来越多的加密货币应用。后来，我在脸书工作，负责天秤座加密货币(现在叫做 Diem)的安全。当时，加密货币是最热门的领域之一，它混合了大量非常有趣的密码原语，迄今为止很少或根本没有在现实世界中使用(零知识证明、聚合签名、门限密码术、多方计算、共识协议、密码累加器、可验证随机函数、可验证延迟函数等)。。。不胜枚举)。然而，没有一本密码学书籍包含关于加密货币的章节。我现在处于一个独特的位置。

我知道我可以写点东西告诉学生、开发者、顾问、安全工程师和其他人现代应用密码学是怎么回事。这将是一本只有几个公式，但充满了许多图表的书。这本书几乎没有历史，但充满了我亲眼目睹的加密失败的现代故事。这将是一本关于传统算法的书，但充满了我个人看到的大规模使用的密码学:TLS、噪声协议框架、信号协议、加密货币、HSM、阈值密码术等等。这将是一本几乎没有理论密码学，但充满了相关内容的书:密码认证密钥交换、零知识证明、后量子密码术等等。

当曼宁出版公司在 2018 年联系我，问我是否想写一本关于密码学的书时，我已经知道了答案。我已经知道我想写什么了。我一直在等待有人给我机会和借口，花时间写我心目中的书。巧合的是，曼宁有一系列“真实世界”的书籍，所以很自然地，我建议我的书扩展它。你面前的一切是两年多努力和热爱的结果。我希望你喜欢它。

## 致谢

感谢玛丽娜·迈克尔斯的持续帮助和见解，没有她，这本书可能不会完成。

感谢 Frances Buran、Sam Zaydel、Michael Rosenberg、Pascal Knecht、Seth David Schoen、Eyal Ronen、Saralynn Chick、Robert Seacord、Eloi Manuel、Rob Wood、Hunter Monk、Jean-Christophe Forest、Liviu Bartha、Mattia Reggiani、Olivier Guerra、Andrey Labunov、Carl Littke、Yan Ivnitskiy、Keller Fuchs、Roman Zabicki、M . K . Saravanan、Sarah Zennou、Daniel Bourdrez、Jason Noll、Ilias Cherkaoui、Felipe Kiran Tummala、Stephen Singam、Jeremy、Jeremy Boone、Thomas Duboucher、Charles Guillemet、Ryan Sleevi、Lionel Rivière、Benjamin Larsen、Gabriel、金奎大·斯普伦克尔斯、Andreas Krogen、Vadim Lyubashevsky、Samuel Neves、Steven (Dongze) Yue、Tony Patti、Graham Steel 以及所有 livebook 评论者对许多讨论和修改以及技术和编辑反馈的意见。

致所有审评员:Adhir Ramjiawan、Al Pezewski、Al Rahimi、Alessandro Campeis、Bobby Lin、Chad Davis、David T Kerns、Domingo Salazar、Eddy Vluggen、gábor Haj ba、Geert Van Laethem、Grzegorz Bernas、Harald Kuhn、Hugo Durana、Jan Pieter Herweijer、杰夫·史密斯、Jim Karabatsos、Joel Kotarski、John Paraskevopoulos、Matt Van Winkle、Michal Rutka、Paul Grebenc、Richard

## 关于这本书

自从我开始写*真实世界密码学*以来，已经有两年多了。我最初打算把它作为对现实世界中使用的加密类型的介绍。但是，当然，这是一个不可能的任务。没有一个领域可以在一本书中概括。由于这个原因，我必须在我想给读者多少细节和我想覆盖多少区域之间取得平衡。我希望你会发现自己和我最终被卷进的盒子一样。如果您正在寻找一本实用的书，教您公司和产品实现和使用的加密技术，如果您对真实世界的加密技术在表面下是如何工作的感到好奇，但又不想寻找一本包含所有实现细节的参考书，那么这本书就是为您准备的。

### 谁应该读这本书

这里列出了我认为会从这本书中受益的人的类型(尽管请不要让任何人把你放进一个盒子里)。

### 学生

如果你正在学习计算机科学、安全或密码学，并希望了解现实世界中使用的密码学(因为你要么是想在行业中找份工作，要么是想在学术界从事应用学科的工作)，那么我相信这是一本适合你的教科书。为什么？因为，正如我在序言中所说的，我也曾经是这样的学生，我写了那本我当时就希望拥有的书。

### 安全从业人员

当我教授应用密码学时，我的大部分学生都是 Pentesters、安全顾问、安全工程师、安全架构师和其他安全角色。由于这个原因，当我试图向非密码学家解释复杂的密码概念时，我收到了许多问题，这些问题使这份材料变得更加精炼。作为一名安全从业者，这本书也是由我为大公司审计过的密码学和我在此过程中了解到或发现的漏洞塑造的。

### 直接或间接使用加密技术的开发人员

我与客户和同事的多次讨论也影响了这项工作，他们基本上既不是安全从业者也不是密码学家。如今，不接触密码学就编写代码变得越来越难，因此，您需要对您所使用的东西有所了解。这本书通过使用不同编程语言中的编码示例给你这种理解，如果你好奇的话，还有更多。

### 对其他领域好奇的密码学家

这本书是对像我这样的人有用的应用密码学的介绍。记住，这是我写给自己的。如果我设法做得很好，一个理论上的密码学家应该能够很快理解应用密码学世界是什么样子的；另一个研究对称加密的人应该能够通过阅读相关章节，迅速了解密码认证的密钥交换；第三个研究协议的人应该能够很快很好地理解量子密码学；诸如此类。

### 希望了解更多信息的工程和产品经理

这本书还试图回答一些我认为更面向产品的问题:这些方法的权衡和限制是什么？我冒了什么风险？这条道路能帮助我遵守法规吗？与政府合作，我需要做这做那吗？

### 好奇的人们想知道真实世界的密码是什么

阅读这本书，你不需要成为我之前列出的任何一种类型。你只需要对现实世界中使用的密码学感到好奇。请记住，我不教密码学的历史，也不教计算机科学的基础知识，所以最起码，你应该在进入这种书之前听说过密码学。

### 假定知识，长版

为了从这本书中获得最大收益，你需要什么？你应该知道，这本书假设你对你的笔记本电脑或互联网的工作原理有一些基本的了解，至少，你应该听说过加密。这本书是关于现实世界的密码学，所以如果你对计算机不熟悉，或者你以前从未听说过 *encryption* 这个词，就很难把事情联系起来。

假设你多少知道自己在做什么，如果你知道什么是位和字节，如果你见过或甚至使用过像异或、左移之类的按位运算，这将是一个真正的优势。如果你没有，这是一个交易破坏者吗？不，但这可能意味着在你继续阅读之前，你不得不不时停下来几分钟去谷歌一下。

事实上，不管你有多有资格，在阅读这本书时，你可能不得不不时停下来，以便从互联网上获取更多的信息。要么是因为我(惭愧)在使用一个术语之前忘记了给它下定义，要么是因为我错误地认为你会知道它。在任何情况下，这都不应该是一件大事，因为我会尽可能地解释我所介绍的不同概念。

最后，当我使用*密码学*这个词的时候，你的大脑可能正在思考数学。如果，除了那个想法，你的脸做了个鬼脸，那么你会很高兴知道你不应该对此太担心。*现实世界的密码术*是关于教导洞察力，以便你获得关于它如何工作的直觉，并且它试图尽可能避免数学上的细节。

当然，如果我说这本书的制作没有涉及数学，那我是在撒谎。没有数学就没有密码学的教学。所以我要说的是:如果你在数学方面达到了一个很好的水平，这是有帮助的，但是如果你没有，这不应该阻止你阅读这本书的大部分内容。除非你对数学有更深入的了解，否则有些章节对你来说可能不太友好，特别是最后几章(第 14 章和第 15 章)关于量子密码术和下一代密码术，但是没有什么是不可能的，你可以通过意志力和搜索矩阵乘法和其他你可能不知道的事情来完成这些章节。如果你决定跳过这些，一定不要跳过第 16 章，因为它是蛋糕上的糖衣。

### 这本书是如何组织的:路线图

*现实世界的密码术*分为两部分。第一部分应该从头到尾阅读，涵盖了密码学的大部分内容:你最终会用它来构建更复杂的系统和协议，就像乐高一样。

*   第 1 章是对真实世界密码学的介绍，给你一些你将会学到的东西。

*   第 2 章讲述哈希函数，这是一种用于从字节串创建唯一标识符的基本加密算法。

*   第 3 章讲述了数据认证以及如何确保没有人会修改你的信息。

*   第四章讨论了加密，它允许两个参与者对观察者隐藏他们的通信。

*   第 5 章介绍了密钥交换，它允许你和其他人交互地协商一个共同的机密。

*   第 6 章描述了非对称加密，它允许多个人给一个人加密信息。

*   第 7 章讨论签名，它是笔和纸签名的加密等价物。

*   第八章谈到了随机性以及如何管理你的机密。

本书的第二部分包含了由这些成分构建的系统。

*   第 9 章教你如何使用加密和认证来保护机器之间的连接(通过 SSL/TLS 协议)。

*   第 10 章描述了端到端加密，这实际上是关于像你我这样的人如何能够相互信任。

*   第 11 章展示了机器如何验证人的身份，以及人如何帮助机器彼此同步。

*   第 12 章介绍了新兴的加密货币领域。

*   第 13 章重点介绍硬件加密技术，这种设备可以防止你的密钥被窃取。

有两个额外的章节:第 14 章关于后量子密码术，第 15 章关于下一代密码术。这两个领域开始进入产品和公司，要么是因为它们变得更加相关，要么是因为它们变得更加实用和高效。如果你跳过最后两章，我不会批评你，但在把这本书放回书架之前，你必须通读第 16 章(最后的话)。第 16 章总结了不同的挑战和不同的教训，一个密码学从业者(指你，一旦你读完这本书)必须牢记在心。就像蜘蛛侠的本叔叔说的，“权力越大，责任越大。”

### 关于代码

这本书包含许多源代码示例，既有编号列表，也有普通文本。在这两种情况下，源代码都被格式化为一个`fixed-width` `font like` `this`以将其与普通文本分开。有时代码也是 **`in` `bold`** 以突出显示与本章中前面的步骤有所不同的代码，例如当一个新的特性添加到现有的代码行时。

在很多情况下，原始源代码已经被重新格式化；我们添加了换行符并重新设计了缩进，以适应书中可用的页面空间。在极少数情况下，这还不够，清单中包含了行继续标记(-)。此外，当在文本中描述代码时，源代码中的注释经常被从清单中删除。代码注释伴随着许多清单，突出了重要的概念。

### liveBook 论坛

购买包括免费访问 Manning Publications 运营的私人网络论坛，在这里你可以对这本书发表评论，提出技术问题，并获得作者和其他用户的帮助。进入论坛请前往[https://live book . manning . com/book/real-world-cryptography/discussion](https://livebook.manning.com/book/real-world-cryptography/discussion)。你也可以在 https://livebook.manning.com/discussion 了解更多关于曼宁的论坛和行为准则。

曼宁对我们读者的承诺是提供一个场所，让读者个人之间以及读者和作者之间进行有意义的对话。作者对论坛的贡献仍然是自愿的(无报酬的)，这并不是对作者参与的任何具体数量的承诺。我们建议你试着问作者一些有挑战性的问题，以免他的兴趣偏离！只要这本书还在印刷中，就可以从出版商的网站上获得论坛和以前讨论的档案。

## 关于作者

大卫·王(David Wong)是 O(1)实验室的高级加密工程师，从事 Mina 加密货币的研究。在此之前，他是脸书 Novi 的 Diem(正式名称为 Libra)加密货币的安全主管，在此之前，他是 NCC 集团加密服务实践的安全顾问。大卫也是《真实世界密码术一书的作者。

在他的职业生涯中，David 参与了几个公共资助的开源审计，比如 OpenSSL 和 Let's Encrypt。他曾在各种会议上发言，包括黑帽和 DEF CON，并在黑帽讲授了一门循环密码学课程。他为 TLS 1.3 和噪声协议框架等标准做出了贡献。他在许多系统中发现了漏洞，包括戈朗标准库中的 CVE-2016-3959，各种 TLS 库中的 CVE-2018-12404，CVE-2018-19608，CVE-2018-16868，CVE-2018-16869 和 CVE-2018-16870。

除此之外，他还是 Disco 协议(【www.discocrypto.com】和)和智能合约的分散应用安全项目([【www.dasp.co】](http://www.dasp.co))的作者。他的研究包括对 RSA 的缓存攻击([http://cat.eyalro.net/](http://cat.eyalro.net/))，基于 QUIC 的协议([https://eprint.iacr.org/2019/028](https://eprint.iacr.org/2019/028))，对 ECDSA 的计时攻击([https://eprint.iacr.org/2015/839](https://eprint.iacr.org/2015/839)，或者 Diffie-Hellman 中的后门([https://eprint.iacr.org/2016/644](https://eprint.iacr.org/2016/644))。这些天你可以在他的博客上看到和读到关于他的消息。

## 关于封面插图

*真实世界密码术*封面上的数字标题为“Indienne de quito”，即基多印第安人。这幅插图取自雅克·格拉塞特·德·圣索弗(1757-1810)的《各国服饰集锦》，书名为《T4 服饰》,于 1797 年在法国出版。每幅插图都是手工绘制和上色的。Grasset de Saint-Sauveur 丰富多样的藏品生动地提醒我们，仅仅在 200 年前，世界上的城镇和地区在文化上是多么的不同。人们彼此隔绝，说着不同的方言和语言。在街上或乡下，很容易通过他们的穿着来辨别他们住在哪里，他们的职业或社会地位。

从那以后，我们的穿着方式发生了变化，当时如此丰富的地区差异也逐渐消失了。现在很难区分不同大陆的居民，更不用说不同的城镇、地区或国家了。也许我们已经用文化多样性换取了更多样化的个人生活——当然是更多样化和快节奏的科技生活。

在一个很难区分计算机书籍的时代，曼宁用基于两个世纪前丰富多样的地区生活的书籍封面来庆祝计算机行业的创造性和主动性，格拉塞特·德圣索维尔的图片使这些书籍重现了生机。