# 一、纵深防御

本章涵盖

*   定义你的攻击面
*   引入纵深防御
*   遵守标准、最佳实践和基本原则
*   识别 Python 安全工具

现在，您比以往任何时候都更信任组织提供您的个人信息。不幸的是，其中一些组织已经将您的信息交给了攻击者。如果你觉得这难以置信，那就去 https://haveibeenpwned.com 看看吧。该网站允许您轻松搜索包含数十亿受损帐户的电子邮件地址的数据库。随着时间的推移，这个数据库只会越来越大。作为软件用户，通过这种共同的经历，我们已经对安全性有了一种认识。

因为你已经打开了这本书，我打赌你会因为另一个原因而喜欢安全。像我一样，你不只是想使用安全的系统；你也想创造它们。大多数程序员重视安全性，但他们并不总是有背景来实现它。我写这本书是为了给你提供一个构建这个背景的工具集。

*安全*是抵御攻击的能力。本章从攻击开始，从外到内分解安全性。随后的章节涵盖了在 Python 中从内到外实现多层防御所需的工具。

每一次攻击都从一个切入点开始。特定系统的所有入口点的总和被称为*攻击面*。在安全系统的攻击表面之下是安全层，一种被称为深度防御的架构设计。防御层遵循标准和最佳实践来确保安全基础。

## 1.1 攻击面

信息 安全已经从一些该做和不该做的事情发展成为一门复杂的学科。是什么驱动了这种复杂性？安全是复杂的，因为攻击是复杂的；出于需要，它是复杂的。如今的攻击形式和规模多种多样。在开发安全系统之前，我们必须对攻击有所了解。

正如我在前面提到的，每一次攻击都从一个脆弱的切入点开始，所有潜在切入点的总和就是你的*攻击面*。每个系统都有独特的攻击面。

攻击和攻击面处于不断变化的稳定状态。随着时间的推移，攻击者变得越来越老练，并且会定期发现新的漏洞。因此，保护您的攻击面是一个永无止境的过程，组织对此过程的承诺应该是持续的。

攻击的切入点可以是系统的用户、系统本身或两者之间的网络。例如，攻击者可能通过电子邮件或聊天将用户作为某些攻击形式的切入点。这些攻击旨在欺骗用户与旨在利用漏洞的恶意内容进行交互。这些攻击包括以下内容:

*   反射式跨站点脚本(XSS)

*   社交工程(例如，网络钓鱼、垃圾邮件)

*   跨站请求伪造

*   开放重定向攻击

或者，攻击者可以将系统本身作为入口点。这种形式的攻击通常旨在利用输入验证不充分的系统。这些攻击的典型示例如下:

*   结构化查询语言(SQL)注入

*   远程代码执行

*   主机头部攻击

*   拒绝服务

攻击者可能将用户和系统作为攻击的切入点，例如持续的跨站脚本或点击劫持。最后，攻击者可以使用用户和系统之间的网络或网络设备作为切入点:

*   中间人攻击

*   重放攻击

这本书教你如何识别和抵御这些攻击，其中有些攻击有整整一章是专门针对它们的(XSS 可以说有两章)。图 1.1 描述了一个典型软件系统的攻击面。四个攻击者同时向该攻击面施加压力，如虚线所示。尽量不要让细节压倒你。这只是为了向您提供一个高层次的预期概述。到本书结束时，你会明白这些攻击是如何运作的。

![CH01_F01_Byrne](img/CH01_F01_Byrne.png)

图 1.1 四个攻击者同时通过用户、系统、网络对一个攻击面施加压力。

在每一个安全系统的攻击表面下都有多层防御；我们不只是保护周边。正如本章开头所提到的，这种分层的安全方法通常被称为 *深度*中的*防御。*

## 1.2 纵深防御

深度防御 一种诞生于美国国家安全局内部的哲学主张，一个系统应该通过多层安全来应对威胁。每一层安全都有双重用途:抵御攻击，并在其他层失败时充当备份。我们从不把鸡蛋放在一个篮子里；即使是优秀的程序员也会犯错，新的漏洞也会定期被发现。

我们先比喻性地探讨一下纵深防御。想象一个只有一层防御的城堡，一支军队。这支军队定期保卫城堡免受袭击。假设这支军队有 10%的失败几率。尽管军队实力强大，但国王对目前的风险水平并不满意。你或我会对一个不能抵抗 10%攻击的系统感到舒服吗？我们的用户会对此感到满意吗？

国王有两个选择来降低风险。一个选择是加强军队。这是可能的，但不具成本效益。消除最后 10%的风险比消除前 10%的风险要昂贵得多。国王没有加强军队，而是决定通过在城堡周围修建护城河来增加一层防御。

护城河降低了多少风险？在城堡被占领之前，军队和护城河都必须失败，所以国王用简单的乘法计算风险。如果护城河像军队一样，有 10%的失败几率，那么每次进攻都有 10% × 10%，或者说 1%的成功几率。想象一下，建立一支失败几率为 1%的军队，要比在地上挖一个洞，然后装满水要昂贵得多。

最后，国王在城堡周围建了一堵墙。就像军队和护城河一样，这堵墙有 10%的失败几率。每次攻击现在都有 10% × 10% × 10%，或者 0.1%的成功几率。

纵深防御的成本收益分析归结为算术和概率。再加一层总比试图完善单一一层划算。深度防御认识到完美的无用性；这是优点，不是缺点。

随着时间的推移，防御层的实现变得比其他实现更成功、更受欢迎；挖护城河的方法就这么多。一个共同问题的共同解决方案出现了。安全社区开始认识到一种模式，一种新技术从实验走向标准化。一个标准团体评估模式，讨论细节，定义规范，安全标准就诞生了。

### 1.2.1 安全标准

许多成功的安全标准已经由国家标准与技术研究所(NIST)、互联网工程任务组(IETF)和万维网联盟(W3C)等组织建立。通过这本书，您将了解如何使用以下标准来保护系统:

*   *(*AES*)——一种对称加密算法*

**   *安全哈希算法 2*(*SHA-2*)——一族密码哈希函数

    *   *(*TLS*)—一种安全的网络协议*

    **   *OAuth 2.0*—一种共享受保护资源的授权协议

    *   *(*【CORS】*)——一种浏览器的资源共享协议*

    **   *(*CSP*)—基于浏览器的攻击缓解标准**** 

 **为什么要标准化？安全标准为程序员提供了构建安全系统的通用语言。公共语言允许来自不同组织的不同人员使用不同的工具构建可互操作的安全软件。例如，web 服务器向每种浏览器提供相同的 TLS 证书；浏览器可以理解来自各种 web 服务器的 TLS 证书。

此外，标准化促进了代码重用。例如， `oauthlib` 是 OAuth 标准的通用实现。这个库由 Django OAuth 工具包和 `flask-oauthlib` 包装，允许 Django 和 Flask 应用程序使用它。

老实说，标准化并不能神奇地解决所有问题。有时候，漏洞是在每个人都接受标准几十年后才被发现的。2017 年，一群研究人员宣布他们破解了 SHA-1([https://沙特·tered.io/](https://shattered.io/))，这是一种加密哈希函数，此前已被业界采用了 20 多年。有时，供应商不会在相同的时间框架内实现一个标准。各大浏览器花了数年时间才支持 CSP 的某些功能。然而，标准化在大多数时候确实有效，我们不能忽视它。

一些最佳实践已经发展成为安全标准的补充。纵深防御本身就是一种最佳实践。像标准一样，安全系统遵循最佳实践；与标准不同，没有最佳 实践的规范。

### 1.2.2 最佳实践

**最佳做法*都不是标准体的产物；相反，它们被迷因、口口相传和像这样的书所定义。这些是你必须要做的事情，有时候你只能靠自己。通过阅读本书，您将学会如何识别和追求这些最佳实践:*

 **   传输中和静止时的加密

*   “不要使用你自己的密码”

*   最小特权原则

数据要么在传输中，要么在处理中，要么处于静止状态。当安全专业人员说“传输中的加密和静态加密”时，他们是在建议其他人在数据在计算机之间移动和写入存储时加密数据。

当安全专家说，“不要开发你自己的密码”，他们是在建议你重用一个有经验的专家的工作，而不是试图自己实现一些东西。依赖工具并不仅仅是为了满足紧迫的期限和编写更少的代码而变得流行。为了安全，它变得流行起来。不幸的是，许多程序员都经历了惨痛的教训。你将通过阅读这本书来学习它。

*最小特权原则* ( *PLP* )保证用户或系统只被授予履行其职责所需的最小权限。在本书中，PLP 被应用于许多主题，如用户授权、OAuth 和 CORS。

图 1.2 展示了典型软件系统的安全标准和最佳实践的安排。

![CH01_F02_Byrne](img/CH01_F02_Byrne.png)

图 1.2 应用于具有安全标准和最佳实践的典型系统的深度防御

没有一层防御是万能的。没有任何安全标准或最佳实践能够独自解决所有安全问题。与大多数 Python 应用程序一样，本书的内容也包含了许多标准和最佳实践。把每一章都想象成一个额外防御层的蓝图。

安全标准和最佳实践看起来和听起来可能不同，但实际上，每一个都是应用相同基础的不同方式。这些基本要素代表了系统 安全性的最基本单元。

### 1.2.3 安全基础知识

*安全* *基本面*在安全系统设计和本书中反复出现。算术、代数或三角学之间的关系类似于安全基础、安全标准或最佳实践之间的关系。通过阅读本书，您将了解如何通过结合以下基础知识来保护系统:

*   *数据完整性*—数据有变化吗？

*   *认证*——你是谁？

*   *数据认证*—这些数据是谁创建的？

*   *不可否认*—谁做了什么？

*   *授权*—你能做什么？

*   *保密性*——谁能访问这个？

*数据完整性* ，有时也称为*消息完整性*，确保数据没有意外损坏(比特腐烂)。它回答了这个问题，“数据有变化吗？”数据完整性保证数据以写入的方式读取。数据读取器可以验证数据的完整性，而不管数据是由谁创作的。

*认证* 回答问题“你是谁？”我们每天都在从事这项活动；它是验证某人或某物的身份的行为。当一个人能够成功响应用户名和密码质询时，就验证了他的身份。然而，认证不仅仅是为了人们；机器也可以被认证。例如，持续集成服务器在从代码库中提取变更之前会进行身份验证。

*数据认证* ，通常称为*消息认证* ，确保数据读取者能够验证数据写入者的身份。它回答了这个问题，“谁创作了这些数据？”与数据完整性一样，当数据读取器和写入器是不同方时，以及当数据读取器和写入器相同时，数据身份验证也适用。

*不可否认* 回答问题，“谁做了什么？”它确保个人或组织无法否认他们的行为。不可否认性可以应用于任何活动，但它对于在线交易和法律协议至关重要。

*授权* ，有时也称为*访问控制*，常与认证混淆。这两个术语听起来相似，但代表不同的概念。如前所述，身份验证回答了“你是谁？”相反，授权回答了“你能做什么？”阅读电子表格、发送电子邮件和取消订单都是用户有权或无权执行的操作。

*保密性* 回答问题“谁能访问这个？”这一基本原则确保了两方或多方可以私下交换数据。未授权方不能以任何有意义的方式阅读或解读机密传输的信息。

这本书教你用这些积木构建解决方案。表 1.1 列出了每个构造块及其对应的解决方案。

表 1.1 安全基础知识

| 

积木

 | 

解决方案

 |
| 数据完整性 | 安全网络协议版本控制包装管理 |
| 认证 | 用户认证系统认证 |
| 数据认证 | 用户注册用户登录工作流程密码重置工作流程用户会话管理 |
| 不可否认 | 网上交易数字签名可信的第三方 |
| 授权 | 用户授权系统间授权文件系统访问授权 |
| 保密性 | 加密算法安全网络协议 |

安全基础相辅相成。每一个单独使用都不是很有用，但是结合起来就很强大了。让我们考虑一些例子。假设电子邮件系统提供数据认证，但不提供数据完整性。作为电子邮件收件人，您可以验证电子邮件发件人的身份(数据认证)，但不能确定电子邮件是否在传输过程中被修改过。不是很有用吧？如果无法验证实际数据，那么验证数据写入者的身份又有什么意义呢？

想象一个新奇的网络协议，无需认证就能保证机密性。窃听者没有办法访问你用这种协议发送的信息(保密性)，但是你不能确定你在向谁发送数据。事实上，你可以发送数据给窃听者。你上一次在不知道你在和谁说话的情况下想和某人进行私人谈话是什么时候？通常，如果你想交换敏感信息，你也想和你信任的人或事交换。

最后，考虑一个支持授权但不支持认证的网上银行系统。这家银行会一直确保你的钱由你管理；它只是不会挑战你先确立自己的身份。在不知道用户是谁的情况下，系统如何授权用户呢？显然，我们都不会把钱存在这家银行。

安全基础是安全系统设计的最基本组成部分。一遍又一遍地重复同样的方法，我们不会有任何结果。相反，我们必须混合搭配它们来构建多层防御。对于每个防御层，我们希望将繁重的工作委托给工具。其中一些工具是 Python 自带的，其他的可以通过 Python 包获得。

## 1.3 工具

本书中的所有例子都是用 Python(准确的说是 3.8 版本)编写的。为什么是 Python？好吧，你不会想读一本不老的书，我也不想写。Python 很受欢迎，而且只会越来越受欢迎。

编程语言的*流行度* ( *PYPL* ) *指数*是基于 Google Trends 数据的编程语言流行度衡量指标。截至 2021 年年中，Python 在 http://pypl.github.io/PYPL.html PYPL 指数()中排名第一，市场份额为 30%。在过去的五年里，Python 的受欢迎程度超过了任何其他编程语言。

Python 为什么这么受欢迎？这个问题有很多答案。大多数人似乎同意两个因素。首先，Python 是一种初学者友好的编程语言。学习、阅读和写作都很容易。第二，Python 生态系统爆发式增长。2017 年 Python 包索引 (PyPI)达到 10 万包。仅用了两年半的时间，这个数字就翻了一番。

我不想写一本只涉及 Python web 安全的书。因此，一些章节介绍了诸如密码学、密钥生成和操作系统等主题。我用一些与安全性相关的 Python 模块来探讨这些主题:

*   `hashlib` *模块*([https://docs.python.org/3/library/hashlib.html](https://docs.python.org/3/library/hashlib.html))—Python 对密码哈希的回答

*   `secrets` *模块*()—安全随机数生成

*   `hmac` *模块*()—基于哈希的消息认证

*   `os` *和* `subprocess` *模块*([https://docs.python.org/3/library/os.html](https://docs.python.org/3/library/os.html)和[https://docs.python.org/3/library/subprocess.html](https://docs.python.org/3/library/subprocess.html))——你通向操作系统的网关

有些工具有自己的专用章节。其他工具在整本书中都有涉及。还有一些只是短暂出现。您将在任何地方学到以下或多或少的知识:

*   `argon2-cffi`()—用于保护密码的功能

*   `cryptography`([https://pypi.org/project/cryptography/](https://pypi.org/project/cryptography/))—一个常用密码函数的 Python 包

*   `defusedxml`([https://pypi.org/project/defusedxml/](https://pypi.org/project/defusedxml/))—一种更安全的 XML 解析方式

*   *guni corn*([https://gunicorn.org](https://gunicorn.org))—用 Python 编写的 web 服务器网关接口

*   *Pipenv*([https://pypi.org/project/pipenv/](https://pypi.org/project/pipenv/))—一个具有许多安全特性的 Python 包管理器

*   `requests`([https://pypi.org/project/requests/](https://pypi.org/project/requests/))—一个简单易用的 HTTP 库

*   `requests-oauthlib`()—客户端 OAuth 2.0 实现

Web 服务器代表了典型攻击面的很大一部分。因此，这本书有许多章节致力于保护 web 应用程序。对于这些章节，我不得不问自己一个很多 Python 程序员都很熟悉的问题:Flask 还是 Django？两个框架都值得尊敬；它们之间的最大区别是极简主义和开箱即用的功能。相对于彼此，Flask 默认为最基本的，Django 默认为全功能的。

作为一个极简主义者，我喜欢烧瓶。不幸的是，它将极简主义应用于许多安全特性。使用 Flask，您的大多数防御层都被委托给第三方库。另一方面，Django 较少依赖第三方支持，具有许多默认启用的内置保护。在本书中，我使用 Django 来演示 web 应用程序安全性。当然，姜戈不是万能药；我也使用以下第三方库:

*   `django-cors-headers`()—CORS 的一个服务器端实现

*   `django-csp`()—CSP 的服务器端实现

*   *Django OAuth* *工具包*([https://pypi.org/project/django-oauth-toolkit/](https://pypi.org/project/django-oauth-toolkit/))—服务器端 OAuth 2.0 实现

*   `django-registration`()—用户注册库

图 1.3 显示了由该工具集组成的堆栈。在这个堆栈中，Gunicorn 通过 TLS 中继来往于用户的流量。用户输入通过 Django 表单验证、模型验证和对象关系映射(orm)进行验证；系统输出通过 HTML 转义进行净化。 `django-cors-headers` 和 `django-csp` 确保每个出站响应分别使用适当的 CORS 和 CSP 报头锁定。 `hashlib` 和 `hmac` 模块执行哈希运算； `cryptography` 包执行加密。 `requests-oauthlib` 与 OAuth 资源服务器接口。最后，Pipenv 防范包存储库中的漏洞。

![CH01_F03_Byrne](img/CH01_F03_Byrne.png)

图 1.3 常见 Python 组件的完整堆栈，在每个级别抵御某种形式的攻击

这本书对框架和库并不固执己见；它不偏心。如果您最喜欢的开源框架被替代，请不要太在意。本书中涉及的每种工具都是通过问两个问题来选择的:

*   *工具成熟了吗？*我们俩最不应该做的事情就是把我们的职业生涯押在昨天诞生的开源框架上。我有意不介绍前沿工具；它被称为*出血边缘*T5 是有原因的。根据定义，处于这个开发阶段的工具不能被认为是安全的。由于这个原因，本书中的所有工具都是成熟的；这里的一切都是经过战斗考验的。

*   *工具流行吗？*这个问题与未来的关系大于现在，与过去无关。具体来说，读者将来使用该工具的可能性有多大？不管我用哪种工具来演示一个概念，记住最重要的是概念本身。

### 1.3.1 保持务实

这是野外手册，不是教科书；我优先考虑专业人士而不是学生。这并不是说安全性的学术方面不重要。这非常重要。但是安全性和 Python 是很大的主题。这份材料的深度仅限于对目标受众最有用的内容。

在这本书里，我介绍了一些哈希和加密的函数。我不讨论这些函数背后的复杂数学。您将了解这些函数的行为方式；你不会学到这些函数是如何实现的。我将向您展示如何以及何时使用它们，以及何时不使用它们。

阅读这本书会让你成为一名更好的程序员，但这本身并不能让你成为安全专家。没有一本书能做到这一点。不要相信做出这种承诺的书。阅读这本书并编写一个安全的 Python 应用程序！使现有系统更加安全。满怀信心地将您的代码投入生产。但是不要把你的 LinkedIn 个人资料标题设为 *密码专家*。

## 总结

*   每个攻击都从一个入口点开始，单个系统的这些入口点的总和称为攻击面。

*   攻击的复杂性推动了对深度防御的需求，这是一种以分层为特征的架构方法。

*   为了互操作性、代码重用和安全性，许多防御层都遵循安全标准和最佳实践。

*   在本质上，安全标准和最佳实践是应用相同基本概念的不同方式。

*   你应该努力将繁重的工作委托给一个工具，比如框架或库；许多程序员都有过惨痛的教训。

*   通过阅读这本书，你会成为一名更好的程序员，但它不会让你成为一名密码学专家。***