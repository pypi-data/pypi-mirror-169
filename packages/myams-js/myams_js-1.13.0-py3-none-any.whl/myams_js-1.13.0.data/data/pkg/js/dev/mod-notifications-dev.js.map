{"version":3,"sources":["mod-notifications.js"],"names":["$","MyAMS","templates","jsrender","require","ITEM_TEMPLATE_STRING","ITEM_TEMPLATE","markup","allowCode","LIST_TEMPLATE_STRING","LIST_TEMPLATE","NotificationsList","values","options","parent","html","render","itemTemplate","timestamp","localTimestamp","Date","useLocalTime","notifications","checkPermission","checkNotificationPromise","Notification","requestPermission","then","e","Promise","resolve","reject","window","console","debug","permission","checkUserPermission","getNotifications","evt","data","extend","target","current","currentTarget","remote","parents","ajax","get","result","tab","attr","text","addNotification","message","showDesktop","pane","notification","badge","count","parseInt","prepend","showDesktopNotification","status","title","body","icon","source","avatar","url","onclick","open","env","bundle","config","modules","push"],"mappings":"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","sourcesContent":["/* global MyAMS */\n/**\n * MyAMS notifications handlers\n */\n\nconst $ = MyAMS.$;\n\nif (!$.templates) {\n\tconst jsrender = require('jsrender');\n\t$.templates = jsrender.templates;\n}\n\n\n/**\n * Notifications list template string\n */\n\nconst ITEM_TEMPLATE_STRING = `\n\t<li class=\"p-1 my-1{{if status}} alert-{{:status}}{{/if}}\">\n\t\t<a class=\"d-flex flex-row\"{{if url}} href=\"{{:url}}\"{{/if}}>\n\t\t\t{{if source.avatar}}\n\t\t\t<img class=\"avatar mx-1 mt-1\" src=\"{{:source.avatar}}\"\n\t\t\t\t alt=\"{{:source.title}}\" title=\"{{:source.title}}\" />\n\t\t\t{{else}}\n\t\t\t<i class=\"avatar fa fa-fw fa-2x fa-user mx-1 mt-1\"\n\t\t\t   title=\"{{:source.title}}\"></i>\n\t\t\t{{/if}}\n\t\t\t<div class=\"flex-grow-1 ml-2\">\n\t\t\t\t<small class=\"timestamp float-right text-muted\">\n\t\t\t\t\t{{*: new Date(data.timestamp).toLocaleString()}}\n\t\t\t\t</small>\n\t\t\t\t<strong class=\"title d-block\">\n\t\t\t\t\t{{:title}}\n\t\t\t\t</strong>\n\t\t\t\t<p class=\"text-muted mb-2\">{{:message}}</p>\n\t\t\t</div>\n\t\t</a>\n\t</li>`;\n\nconst ITEM_TEMPLATE = $.templates({\n\tmarkup: ITEM_TEMPLATE_STRING,\n\tallowCode: true\n});\n\n\nconst LIST_TEMPLATE_STRING = `\n\t<ul class=\"list-style-none flex-grow-1 overflow-auto m-0 p-0\">\n\t\t{{for notifications tmpl=~itemTemplate /}}\n\t</ul>\n\t{{if !~options.hideTimestamp}}\n\t<div class=\"timestamp border-top pt-1\">\n\t\t<span>{{*: MyAMS.i18n.LAST_UPDATE }}{{: ~timestamp.toLocaleString() }}</span>\n\t\t<i class=\"fa fa-fw fa-sync float-right\"\n\t\t   data-ams-click-handler=\"MyAMS.notifications.getNotifications\"\n\t\t   data-ams-click-handler-options='{\"localTimestamp\": \"{{: ~useLocalTime }}\"}'></i>\n\t</div>\n\t{{/if}}`;\n\nconst LIST_TEMPLATE = $.templates({\n\tmarkup: LIST_TEMPLATE_STRING,\n\tallowCode: true\n});\n\n\nclass NotificationsList {\n\n\t/**\n\t * List constructor\n\t *\n\t * @param values: notifications data (may be loaded from JSON)\n\t * @param options: list rendering options\n\t */\n\tconstructor(values, options={}) {\n\t\tthis.values = values;\n\t\tthis.options = options;\n\t}\n\n\t/**\n\t * Render list into given parent\n\t *\n\t * @param parent: JQUery parent object into which the list must be rendered\n\t */\n\trender(parent) {\n\t\t$(parent).html(LIST_TEMPLATE.render(this.values, {\n\t\t\titemTemplate: ITEM_TEMPLATE,\n\t\t\ttimestamp: this.options.localTimestamp ?\n\t\t\t\tnew Date() : new Date(this.values.timestamp),\n\t\t\tuseLocalTime: this.options.localTimestamp ? 'true' : 'false',\n\t\t\toptions: this.options\n\t\t}));\n\t}\n}\n\n\nexport const notifications = {\n\n\t/**\n\t * Check permission to display desktop notifications\n\t */\n\tcheckPermission: () => {\n\n\t\tconst checkNotificationPromise = () => {\n\t\t\ttry {\n\t\t\t\tNotification.requestPermission().then();\n\t\t\t} catch (e) {\n\t\t\t\treturn false;\n\t\t\t}\n\t\t\treturn true;\n\t\t};\n\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tif (!('Notification' in window)) {\n\t\t\t\tconsole.debug(\"Notifications are not supported by this browser!\");\n\t\t\t\tresolve(false);\n\t\t\t} else if (Notification.permission !== 'denied') {\n\t\t\t\tif (Notification.permission === 'default') {\n\t\t\t\t\tif (checkNotificationPromise()) {\n\t\t\t\t\t\tNotification.requestPermission().then((permission) => {\n\t\t\t\t\t\t\tresolve(permission === 'granted');\n\t\t\t\t\t\t});\n\t\t\t\t\t} else {\n\t\t\t\t\t\tNotification.requestPermission((permission) => {\n\t\t\t\t\t\t\tresolve(permission === 'granted');\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tresolve(true);\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tresolve(false);\n\t\t\t}\n\t\t});\n\t},\n\n\tcheckUserPermission: () => {\n\t\tMyAMS.notifications.checkPermission().then(() => {});\n\t},\n\n\t/**\n\t * Load user notifications\n\t *\n\t * @param evt: source event\n\t * @param options: notifications options (which can also be extracted from event data)\n\t */\n\tgetNotifications: (evt, options) => {\n\n\t\tconst\n\t\t\tdata = $.extend({}, options, evt.data),\n\t\t\ttarget = $(evt.target),\n\t\t\tcurrent = $(evt.currentTarget),\n\t\t\tremote = current.data('ams-notifications-source') ||\n\t\t\t\tcurrent.parents('[data-ams-notifications-source]').data('ams-notifications-source');\n\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tMyAMS.require('ajax').then(() => {\n\t\t\t\tMyAMS.ajax.get(remote, current.data('ams-notifications-params') || '',\n\t\t\t\t\tcurrent.data('ams-notifications-options') || {}).then((result) => {\n\t\t\t\t\tconst\n\t\t\t\t\t\ttab = $(target.data('ams-notifications-target') ||\n\t\t\t\t\t\ttarget.parents('[data-ams-notifications-target]').data('ams-notifications-target') ||\n\t\t\t\t\t\tcurrent.attr('href'));\n\t\t\t\t\tnew NotificationsList(result, data).render(tab);\n\t\t\t\t\t$('#notifications-count').text('');\n\t\t\t\t\tnotifications.checkUserPermission();\n\t\t\t\t\tresolve();\n\t\t\t\t}, reject);\n\t\t\t}, reject);\n\t\t});\n\t},\n\n\t/**\n\t * Add new notification to notifications list\n\t *\n\t * @param message: notification element\n\t * @param showDesktop: if true, also try to display desktop notification\n\t */\n\taddNotification: (message, showDesktop) => {\n\n\t\tconst\n\t\t\tpane = $('ul', '#notifications-pane'),\n\t\t\tnotification = $(ITEM_TEMPLATE.render(message)),\n\t\t\tbadge = $('#notifications-count'),\n\t\t\tcount = parseInt(badge.text()) || 0;\n\n\t\tpane.prepend(notification);\n\t\tbadge.text(count + 1);\n\n\t\tif (showDesktop) {\n\t\t\tnotifications.showDesktopNotification(message);\n\t\t}\n\t},\n\n\t/**\n\t * Show new desktop notification\n\t *\n\t * @param message: notification elements\n\t */\n\tshowDesktopNotification: (message) => {\n\n\t\tnotifications.checkPermission().then((status) => {\n\t\t\tif (!status) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tconst\n\t\t\t\toptions = {\n\t\t\t\t\ttitle: message.title,\n\t\t\t\t\tbody: message.message,\n\t\t\t\t\ticon: message.source.avatar\n\t\t\t\t},\n\t\t\t\tnotification = new Notification(options.title, options);\n\n\t\t\tif (message.url) {\n\t\t\t\tnotification.onclick = () => {\n\t\t\t\t\twindow.open(message.url);\n\t\t\t\t};\n\t\t\t}\n\t\t});\n\t}\n}\n\n\n/**\n * Global module initialization\n */\nif (MyAMS.env.bundle) {\n\tMyAMS.config.modules.push('notifications');\n} else {\n\tMyAMS.notifications = notifications;\n\tconsole.debug(\"MyAMS: notifications module loaded...\");\n}\n"],"file":"mod-notifications-dev.js"}