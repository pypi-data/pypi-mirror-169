{"version":3,"file":"reviewReplyEditorModel.js","names":["RB","ReviewRequestPage","ReviewReplyEditor","Backbone","Model","extend","defaults","anchorPrefix","contextID","contextType","commentID","hasDraft","replyObject","review","reviewReply","richText","text","replyClasses","diff_comments","DiffCommentReply","screenshot_comments","ScreenshotCommentReply","file_attachment_comments","FileAttachmentCommentReply","general_comments","GeneralCommentReply","initialize","on","_setupReviewReply","save","get","valueAttr","richTextAttr","obj","ReplyClass","console","assert","parentObject","replyToID","id","set","trigger","ready","forceTextType","includeTextTypes","attrs","success","resetStateIfEmpty","strip","isNew","_resetState","destroy","oldReviewReply","previous","off","listenTo","shouldDiscardIfEmpty","discardIfEmpty"],"sources":["reviewReplyEditorModel.es6.js"],"sourcesContent":["/**\n * An editor for replying to parts of a review.\n *\n * This will track the editing state of a reply to the body top/bottom of\n * a review or a comment, and handles saving of the reply.\n */\nRB.ReviewRequestPage.ReviewReplyEditor = Backbone.Model.extend({\n    defaults: {\n        anchorPrefix: null,\n        contextID: null,\n        contextType: null,\n        commentID: null,\n        hasDraft: false,\n        replyObject: null,\n        review: null,\n        reviewReply: null,\n        richText: null,\n        text: '',\n    },\n\n    replyClasses: {\n        diff_comments: RB.DiffCommentReply,\n        screenshot_comments: RB.ScreenshotCommentReply,\n        file_attachment_comments: RB.FileAttachmentCommentReply,\n        general_comments: RB.GeneralCommentReply,\n    },\n\n    /**\n     * Initialize the model.\n     */\n    initialize() {\n        this.on('change:reviewReply', this._setupReviewReply, this);\n        this._setupReviewReply();\n    },\n\n    /**\n     * Save the current reply.\n     *\n     * This will trigger the \"saving\" event before saving, and will trigger\n     * \"saved\" after it succeeds.\n     */\n    save() {\n        const contextType = this.get('contextType');\n        const reviewReply = this.get('reviewReply');\n        let valueAttr;\n        let richTextAttr;\n        let obj;\n\n        if (contextType === 'body_top') {\n            valueAttr = 'bodyTop';\n            richTextAttr = 'bodyTopRichText';\n            obj = reviewReply;\n        } else if (contextType === 'body_bottom') {\n            valueAttr = 'bodyBottom';\n            richTextAttr = 'bodyBottomRichText';\n            obj = reviewReply;\n        } else {\n            valueAttr = 'text';\n            richTextAttr = 'richText';\n            obj = this.get('replyObject');\n\n            if (!obj) {\n                const ReplyClass = this.replyClasses[contextType];\n\n                console.assert(ReplyClass,\n                               \"Unexpected context type '%s'\",\n                               contextType);\n\n                obj = new ReplyClass({\n                    parentObject: reviewReply,\n                    replyToID: this.get('contextID'),\n                    id: this.get('commentID'),\n                });\n            }\n        }\n\n        this.set('replyObject', obj);\n\n        this.trigger('saving');\n\n        obj.ready({\n            ready: () => {\n                const text = this.get('text');\n\n                if (text) {\n                    obj.set(valueAttr, text);\n                    obj.set(richTextAttr, this.get('richText'));\n                    obj.set({\n                        forceTextType: 'html',\n                        includeTextTypes: 'raw',\n                    });\n\n                    obj.save({\n                        attrs: [valueAttr, richTextAttr, 'forceTextType',\n                                'includeTextTypes', 'replyToID'],\n                        success: function() {\n                            this.set({\n                                hasDraft: true,\n                                text: obj.get(valueAttr),\n                                richText: true,\n                            });\n                            this.trigger('textUpdated');\n                            this.trigger('saved');\n                        }\n                    }, this);\n                } else {\n                    this.resetStateIfEmpty();\n                }\n            },\n        });\n    },\n\n    /**\n     * Reset the editor state, if the text isn't set.\n     *\n     * If the text attribute has a value, this will do nothing.\n     * Otherwise, it will destroy the reply or the comment (depending on\n     * what is being replied to), and then trigger \"resetState\".\n     */\n    resetStateIfEmpty() {\n        const text = this.get('text');\n\n        if (text.strip() !== '') {\n            return;\n        }\n\n        const replyObject = this.get('replyObject');\n\n        if (!replyObject || replyObject.isNew()) {\n            this._resetState();\n        } else {\n            const contextType = this.get('contextType');\n\n            if (contextType === 'body_top' ||\n                contextType === 'body_bottom') {\n                this._resetState(true);\n            } else {\n                replyObject.destroy({\n                    success: this._resetState\n                }, this);\n            }\n        }\n    },\n\n    /**\n     * Set up a new ReviewReply for this editor.\n     *\n     * This will first stop listening to any events on an old reviewReply.\n     *\n     * It will then listen for \"destroy\" and \"published\" events on the new\n     * reply. If either triggers, the \"discarded\" or \"published\" signals\n     * (respectively) will be triggered, and the state of the editor will reset.\n     */\n    _setupReviewReply() {\n        const reviewReply = this.get('reviewReply');\n        const oldReviewReply = this.previous('reviewReply');\n\n        if (oldReviewReply) {\n            oldReviewReply.off(null, null, this);\n        }\n\n        this.listenTo(reviewReply, 'destroyed', () => {\n            this.trigger('discarded');\n            this._resetState();\n        });\n\n        this.listenTo(reviewReply, 'published', () => {\n            this.trigger('published');\n            this._resetState(false);\n        });\n    },\n\n    /**\n     * Resets the state of the editor.\n     *\n     * Args:\n     *     shouldDiscardIfEmpty (boolean):\n     *         Whether to discard the entire reply if there are no individual\n     *         comments.\n     */\n    _resetState: function(shouldDiscardIfEmpty) {\n        this.set({\n            commentID: null,\n            hasDraft: false,\n            replyObject: null,\n        });\n\n        if (shouldDiscardIfEmpty === false) {\n            this.trigger('resetState');\n        } else {\n            this.get('reviewReply').discardIfEmpty({\n                success: () => this.trigger('resetState'),\n            });\n        }\n    },\n});\n"],"mappings":"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"}