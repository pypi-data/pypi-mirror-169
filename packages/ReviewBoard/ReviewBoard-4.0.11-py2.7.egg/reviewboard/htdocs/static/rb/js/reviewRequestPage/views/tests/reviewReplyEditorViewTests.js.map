{"version":3,"file":"reviewReplyEditorViewTests.js","names":["suite","reviewReply","editor","view","beforeEach","$container","$","appendTo","$testsScratch","RB","ReviewReply","id","spyOn","and","callFake","options","context","success","call","ReviewRequestPage","ReviewReplyEditor","anchorPrefix","replyObject","review","Review","parentObject","ReviewRequest","contextType","contextID","ReviewReplyEditorView","model","el","_$commentsList","append","describe","it","commentText","now","moment","$el","_makeCommentElement","commentID","text","render","expect","get","toBe","valueOf","milliseconds","_$draftComment","_$addCommentLink","is","click","not","hasClass","length","trigger","$draftEl","fn","callThrough","set","data","user_infobox","toHaveBeenCalled","timesince","$anchor","children","attr","$floatingAnchor","find","openCommentEditor","testRendering","richText","expectedHTML","$comment","$reviewText","html"],"sources":["reviewReplyEditorViewTests.es6.js"],"sourcesContent":["suite('rb/reviewRequestPage/views/ReviewReplyEditorView', function() {\n    let reviewReply;\n    let editor;\n    let view;\n\n    beforeEach(function() {\n        const $container = $('<div/>').appendTo($testsScratch);\n\n        reviewReply = new RB.ReviewReply({\n            id: 121\n        });\n\n        /* Some tests will invoke this, so just pretend it works. */\n        spyOn(reviewReply, 'discardIfEmpty').and.callFake(\n            (options, context) => options.success.call(context));\n\n        editor = new RB.ReviewRequestPage.ReviewReplyEditor({\n            anchorPrefix: 'header-reply',\n            replyObject: reviewReply,\n            review: new RB.Review({\n                id: 42,\n                parentObject: new RB.ReviewRequest(),\n            }),\n            reviewReply: reviewReply,\n            contextType: 'rcbt',\n            contextID: '100',\n        });\n\n        view = new RB.ReviewRequestPage.ReviewReplyEditorView({\n            model: editor,\n            el: $testsScratch,\n        });\n\n        /* Necessary to do pre-render so we can use makeCommentElement. */\n        view._$commentsList = $('<ul class=\"reply-comments\"/>');\n\n        $container\n            .append(view._$commentsList)\n            .append($('<a href=\"#\" class=\"add_comment_link\">New Comment</a>'));\n    });\n\n    describe('Construction', function() {\n        it('Populate from draft comment', function() {\n            const commentText = 'Test comment';\n            const now = moment();\n            const $el = view._makeCommentElement({\n                commentID: 16,\n                now: now,\n                text: commentText,\n            });\n\n            view.render();\n\n            expect(editor.get('commentID')).toBe(16);\n            expect(editor.get('text')).toBe(commentText);\n            expect(editor.get('hasDraft')).toBe(true);\n            expect(editor.get('timestamp').valueOf())\n                .toBe(now.milliseconds(0).valueOf());\n            expect(view._$draftComment[0]).toBe($el[0]);\n            expect(view._$addCommentLink.is(':visible')).toBe(false);\n        });\n    });\n\n    describe('Actions', function() {\n        it('Add comment link', function() {\n            view.render();\n\n            expect(view._$addCommentLink.is(':visible')).toBe(true);\n            view._$addCommentLink.click();\n\n            expect(view._$addCommentLink.is(':visible')).toBe(false);\n            expect(view._$draftComment).not.toBe(null);\n            expect(view._$draftComment.hasClass('draft')).toBe(true);\n        });\n    });\n\n    describe('Event handling', function() {\n        it('Comment discarded', function() {\n            view._makeCommentElement({\n                text: 'Test comment',\n            });\n\n            view.render();\n\n            let $el = view.$('.reply-comments li');\n            expect($el.length).toBe(1);\n\n            reviewReply.trigger('destroyed');\n\n            $el = view.$('.reply-comments li');\n            expect($el.length).toBe(0);\n            expect(view._$draftComment).toBe(null);\n        });\n\n        it('Comment published', function() {\n            const $draftEl = view._makeCommentElement({\n                commentID: 16,\n            });\n\n            spyOn($.fn, 'user_infobox').and.callThrough();\n            spyOn($.fn, 'timesince').and.callThrough();\n\n            view.render();\n            editor.set('text', 'Test **comment**');\n            reviewReply.trigger('published');\n\n            const $el = view.$('.reply-comments li');\n\n            expect($el.length).toBe(1);\n            expect($draftEl).not.toBe($el);\n            expect($el.hasClass('draft')).toBe(false);\n            expect($el.data('comment-id')).toBe(16);\n            expect(view._$draftComment).toBe(null);\n            expect($.fn.user_infobox).toHaveBeenCalled();\n            expect($.fn.timesince).toHaveBeenCalled();\n\n            const $anchor = $el.children('.comment-anchor');\n            expect($anchor.length).toBe(1);\n            expect($anchor.attr('name')).toBe('header-reply121');\n\n            const $floatingAnchor = $el.find('> .floating-anchor > a');\n            expect($floatingAnchor.length).toBe(1);\n            expect($floatingAnchor.attr('href')).toBe('#header-reply121');\n            expect($floatingAnchor.hasClass('fa fa-link fa-flip-horizontal'))\n                .toBe(true);\n        });\n    });\n\n    describe('Methods', function() {\n        it('openCommentEditor', function() {\n            view.render();\n\n            expect(view._$addCommentLink.is(':visible')).toBe(true);\n            expect(view._$draftComment).toBe(null);\n\n            view.openCommentEditor();\n\n            expect(view._$addCommentLink.is(':visible')).toBe(false);\n            expect(view._$draftComment).not.toBe(null);\n            expect(view._$draftComment.hasClass('draft')).toBe(true);\n        });\n    });\n\n    describe('Text rendering', function() {\n        function testRendering(richText, expectedHTML) {\n            view.render();\n\n            const $comment = view._makeCommentElement({\n                text: '<p><strong>Test</strong> &amp;lt;</p>',\n                richText: richText,\n            });\n\n            const $reviewText = $comment.find('.reviewtext');\n            expect($reviewText.length).toBe(1);\n            expect($reviewText.hasClass('rich-text')).toBe(richText);\n            expect($reviewText.html()).toBe(expectedHTML);\n        }\n\n        it('richText=true', function() {\n            testRendering(true, '<p><strong>Test</strong> &amp;lt;</p>');\n        });\n\n        it('richText=false', function() {\n            testRendering(false,\n                          '&lt;p&gt;&lt;strong&gt;Test&lt;/strong&gt; ' +\n                          '&amp;amp;lt;&lt;/p&gt;');\n        });\n    });\n});\n"],"mappings":"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"}